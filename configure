#!/usr/bin/env bash
################################################################################
#
# Configure scipt for Petit-ami
#
# Sets up the complete Petit-ami project.
#
################################################################################

################################################################################
#
# Routines
#

#
# Check command exists
#
# Uses the bash "command" built in.
#
function checkexists {

    command -v $1 >/dev/null
    rc=$?
    if [[ $rc != 0 ]] ; then

        echo "*** No $1 was found"

    fi

}

################################################################################
#
# Set default variables
#
if [ "$(uname)" = "Linux" ]
then

    compiler="gcc"
    bits="64"
    host="linux"

elif [ "$(uname)" = "FreeBSD" ]
then

    compiler="clang"
    bits="64"
    host="bsd"

elif [ "$(uname)" = "Darwin" ]
then

    compiler="clang"
    bits="64"
    host="bsd"

else

    echo "*** Supported operating system not found"
    exit 1

fi

################################################################################
#
# Make sure used packages are installed.
#
if [ "$host" = "linux" ]
then

    sudo apt-get -y install alsa alsa-tools
    sudo apt-get -y install libasound2-dev
    sudo apt-get -y install openssl
    sudo apt-get -y install libssl-dev
    sudo apt-get -y install fluidsynth
    sudo apt-get -y install libfluidsynth-dev
    sudo apt-get -y install gawk
    sudo apt-get -y install bison
    sudo apt-get -y install git
    sudo apt-get -y install openssl
    sudo apt-get -y install libx11-dev

elif [ "$host" = "bsd" ]
then

    sudo pkg install openssl
    sudo pkg install fluidsynth
    sudo pkg install gawk
    sudo pkg install bison
    sudo pkg install git
    sudo pkg install openssl
    sudo pkg install gmake

fi

################################################################################
#
# Determine if needed programs exist. The only fatal one is gcc, because we
# need that to compile Petit-Ami. The rest will impact the running of various
# test and build scripts.
#


checkexists grep
checkexists diff
checkexists sed
checkexists rm
checkexists cp
checkexists mv
checkexists ls
checkexists tar

#
# Fail on no C compiler found
#
checkexists $compiler > /dev/null
if [[ $rc != 0 ]] ; then

    echo "*** Aborting: cannot complete without known C compiler"
    exit 1

fi

#
# Check user arguments
#
for var in "$@"
do

    if [ $var = "--help" ]
    then

        echo "Configure program for Petit-Ami"
        exit 0

    else

        echo "*** Option not recognized"
        echo "Terminating"
        exit 0

    fi

done

#
# Set the version of libc override that is needed.
#
if [ "$host" = "linux" ]
then

    setver_glibc

fi

echo "Configure completed!"
